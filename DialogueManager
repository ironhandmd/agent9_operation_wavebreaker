
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using TMPro;
using UnityEngine.UI;

public class DialogueManager : MonoBehaviour
{
    [Header("Player Reference")]
    private Move playerMove;
    private Jump playerJump;
    private PlayerFire playerFire;

    [Header("UI References")]
    public GameObject dialoguePanel;
    public TextMeshProUGUI dialogueText;
    public Image portraitImage;

    [Header("Dialogue Settings")]
    public float typingSpeed = 0.03f;

    [System.Serializable]
    public class PortraitData
    {
        public string characterName;
        public Sprite portraitSprite;
    }

    [Header("Portrait Library (Add Characters Here)")]
    public PortraitData[] portraits;

    [Header("Dialogue Lines")]
    [TextArea(2, 4)]
    public string[] dialogueLines;

    private int currentLineIndex = 0;
    private bool isTyping = false;

    void Start()
    {
        playerFire = FindObjectOfType<PlayerFire>();
        playerMove = FindObjectOfType<Move>();
        playerJump = FindObjectOfType<Jump>();
        if (dialogueLines.Length > 0)
            StartDialogue(dialogueLines);
    }

    public void StartDialogue(string[] lines)
    {
        dialogueLines = lines;
        currentLineIndex = 0;

        dialoguePanel.SetActive(true);

        if (playerMove != null)
            playerMove.canAct = false;
        playerJump.canAct = false;
        ShowLine();
    }

    private void ShowLine()
    {
        StopAllCoroutines();
        SetPortrait(dialogueLines[currentLineIndex]);
        StartCoroutine(TypeLine(dialogueLines[currentLineIndex]));
    }

    private void SetPortrait(string line)
    {
       

        string speaker = line.Split(':')[0];

        foreach (var p in portraits)
        {
            if (p.characterName.Equals(speaker, System.StringComparison.OrdinalIgnoreCase))
            {
                portraitImage.sprite = p.portraitSprite;
                return;
            }
        }

     
        portraitImage.enabled = false;
    }

    IEnumerator TypeLine(string line)
    {
        isTyping = true;
        dialogueText.text = "";

        foreach (char c in line)
        {
            dialogueText.text += c;
            yield return new WaitForSeconds(typingSpeed);
        }

        isTyping = false;
    }

    void Update()
    {
        if (!dialoguePanel.activeSelf) return;

        if (Input.GetKeyDown(KeyCode.Space))
        {
            if (isTyping)
            {
                StopAllCoroutines();
                dialogueText.text = dialogueLines[currentLineIndex];
                isTyping = false;
            }
            else
            {
                currentLineIndex++;

                if (currentLineIndex < dialogueLines.Length)
                    ShowLine();
                else
                    EndDialogue();
            }
        }
    }

    private void EndDialogue()
    {
        dialoguePanel.SetActive(false);
        if (playerMove != null) playerMove.enabled = true;
     if (playerFire != null) playerFire.enabled = true;
        if (playerMove != null)
            playerMove.canAct = true;
        playerJump.canAct = true;
       
    }

